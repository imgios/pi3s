apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  dependsOn:
    - name: longhorn
      namespace: longhorn-system
  interval: 30m
  releaseName: monitoring
  chart:
    spec:
      chart: kube-prometheus-stack
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
      interval: 30m
  targetNamespace: monitoring
  install:
    createNamespace: true
    remediation:
      retries: 10
  upgrade:
    remediation:
      retries: 10
  values:
    grafana:
      ingress:
        enabled: true
        ingressClassName: traefik
        hosts:
          - grafana.homelab.local
    alertmanager:
      templateFiles:
        telegram.tmpl: |-
          {{ define "telegram.homelab.message" }}
          {{- if eq .Status "firing" -}}
              {{- if eq .CommonLabels.severity "critical" -}}
                  🔴 Alert: {{ .CommonLabels.alertname }}
              {{- else if eq .CommonLabels.severity "warning" -}}
                  🟠 Alert: {{ .CommonLabels.alertname }}
              {{- else -}}
                  ⚪️ Alert: {{ .CommonLabels.alertname }}
              {{- end }}
              Status: 🔥 FIRING
              Severity: {{ if eq .CommonLabels.severity "critical" }}🔴 {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}🟠 {{ .CommonLabels.severity | title }}{{ else }}⚪️ {{ .CommonLabels.severity | title }}{{ end }}
          {{- else if eq .Status "resolved" -}}
              ⚪️ Alert: {{ .CommonLabels.alertname }}
              Status: ✅ RESOLVED
              Severity: {{ if eq .CommonLabels.severity "critical" }}🟢 {{ .CommonLabels.severity | title }}{{ else if eq .CommonLabels.severity "warning" }}🟢 {{ .CommonLabels.severity | title }}{{ else }}⚪️ {{ .CommonLabels.severity | title }}{{ end }}
          {{- end }}
          {{- range .Alerts -}}
              {{- if .Labels.job }}
                  Job: `{{ .Labels.job }}`
              {{- end }}
              {{- if .Labels.namespace }}
                  Namespace: `{{ .Labels.namespace }}`
              {{- end }}
              {{- if .Labels.instance }}
                  Instance: `{{ .Labels.instance }}`
              {{- end }}
              {{- if .Annotations.runbook_url }}
                  [>_ RunbookURL]({{ .Annotations.runbook_url }})
              {{- end }}
              {{- if gt (len .GeneratorURL) 0 }}<a href="{{ .GeneratorURL }}">source</a>  |  {{ end }}
              {{- if gt (len .SilenceURL) 0 }}<a href="{{ .SilenceURL }}">🔕 silence</a>  |  {{ end }}
              {{- if gt (len .DashboardURL) 0 }}📊 <a href="{{ .DashboardURL }}">dashboard</a>  |  {{ end }}
              {{- if gt (len .PanelURL) 0 }}<a href="{{ .PanelURL }}">panel</a> {{- end -}}
          {{- end }}
          {{ end }}
