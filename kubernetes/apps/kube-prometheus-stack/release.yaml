apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
spec:
  dependsOn:
    - name: longhorn
      namespace: longhorn-system
  interval: 30m
  releaseName: monitoring
  chart:
    spec:
      chart: kube-prometheus-stack
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
      interval: 30m
  targetNamespace: monitoring
  install:
    createNamespace: true
    remediation:
      retries: 10
  upgrade:
    remediation:
      retries: 10
  values:
    grafana:
      defaultDashboardsTimezone: "Europe/Rome"
      admin:
        existingSecret: grafana-admin-creds
      ingress:
        enabled: true
        ingressClassName: traefik
        hosts:
          - grafana.homelab.giosuesulipano.it
      alerting:
        templates.yaml:
          apiVersion: 1
          templates:
            - name: telegram.message.homelab
              orgId: 1
              template: |
                {{ `
                {{ define "__alerts_list" -}}
                {{ range . }}
                {{if ne (index .Labels "alertname") "" -}}
                {{ if eq .Status "firing" }}ğŸ”´{{ else }}ğŸŸ¢{{ end }}
                    {{- if ne (index .Labels "severity") "" -}}
                        <u><b>{{ index .Labels "severity" }}</b></u> {{ end -}}
                <b>{{ index .Labels "alertname" }}</b> ğŸ•™ {{ .StartsAt.Format "15:04:05    ğŸ—“ï¸ 2006-01-02" }}{{ end -}}
                {{ if len .Annotations }}
                <i>Annotations:</i>
                    {{ range .Annotations.SortedPairs -}}
                    - {{ .Name }}: {{ .Value }}
                    {{ end -}}
                {{ end }}
                {{ if len .Labels -}}
                <i>Labels:</i>
                    {{ range .Labels.SortedPairs -}}
                    - {{ .Name }}: {{ .Value }}
                    {{ end -}}
                {{ end }}
                <i>Value:</i> <pre>{{ .ValueString }}</pre>
                    {{- if gt (len .GeneratorURL) 0 }}<a href="{{ .GeneratorURL }}">source</a>  |  {{ end }}
                    {{- if gt (len .SilenceURL) 0 }}<a href="{{ .SilenceURL }}">ğŸ”• silence</a>  |  {{ end }}
                    {{- if gt (len .DashboardURL) 0 }}ğŸ“ <a href="{{ .DashboardURL }}">dashboard</a>  |  {{ end }}
                    {{- if gt (len .PanelURL) 0 }}<a href="{{ .PanelURL }}">panel</a> {{- end -}}
                    <pre>--------</pre>
                {{- end -}} {{- /* range */ -}}
                {{- end -}} {{- /* define __alerts_list */ -}}

                {{ define "__telegram.title" -}}
                {{ if ne (index .CommonLabels "severity") "" }} <u><b>{{ index .CommonLabels "severity" }}</b></u> {{ end -}}
                {{ if ne (index .CommonLabels "alertname") "" -}}
                    [{{ index .CommonLabels "alertname" }}]
                {{- end -}}
                {{- end -}}{{- /* define __telegram */ -}}

                {{ define "telegram.message" }}
                    {{ if gt (len .Alerts.Firing) 0 }}
                    ğŸš¨ <b>ALARM</b> (#{{ .Alerts.Firing | len }})
                    {{- template "__alerts_list" .Alerts.Firing }}{{ end -}}
                    {{ if gt (len .Alerts.Resolved) 0 }}
                    âœ… <b>RESOLVED</b>{{ template "__telegram.title" . }} (#{{ .Alerts.Resolved | len }})
                    {{- template "__alerts_list" .Alerts.Resolved }}{{ end }}

                <a href="{{ .ExternalURL }}">ğŸ“² Grafana</a>
                {{- end -}}
                ` }}
